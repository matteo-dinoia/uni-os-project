# Project report
## Master
The master process's only role is to create other processes and read the simulation constats from file to then call ipc_manager and pass them to it, so that it can take care of initialization of the respective data structures. It also makes sure that all processes and IPCs are correctly closed when the program is interrupted for any reason.

## Shared memory and ipc_manager
Throughout our work we came to the the conclusion that the best way to manage the data receceived and generated by the program was to use data structures stored in shared memory. Such structures are defined in the file shared_memory.c.

To make sure that operations on those structures are always memory safe and to avoid writing them concurrently we implemented ipc_manager.c. This module is the one responsible for writing on the shared structures and provides public methods for the other modules to access and, when needed, modify the data. This module also hides the implementation of the shared memory and limits the other modules access to it in order to prevent unwanted changes.

## Port and ship communications
To implement communicatios between the ports and ships we are using two message queues. The first handles messages sent from the ships to the ports while the second handles the oppsite. A "conversation" in only started by the ship after it succefully docks to the port. The ship communicates to the port the quantity and type of the goods it wants to sell or buy. The port then proceeds to respond with the maximum quantity of the types requested that it can satisfy. The port also needs to specify the expiry date of the goods that is selling, making it necessary to split its response across multiple messages.

## Port
The port only listens to the message queue and responds when one is received, so is pretty straightforward. The only other things it does are handling the swell weather event and updating it's supply and demand at the start of each simulation's day, when it receives a custom SIGDAY signal from the master. The latter operation is not done within the signal handler to avoid an impossible to solve deadlock, without using threads or creating new processes.

## Ship
The ship processes can be considered the heart of the simulation as it is the one that picks the destinations and the goods to buy and sell. Therefore it is the process that makes most of the decisions during the simulation. As such it is most critical to choose a good enough option in a relatively short time frame. To do that we have decided calculate a score for every possible option to then add noise on top, to avoid starvation and all the ships ending up making the same choices (for example all ships storming to the same ports at the same time). When ships are trying to pick a destination port if they are empty they will choose one of the ports that is visted less often, if they are transporting cargo they will choose choose a port based on how much cargo they can sell at it and taking expiry date into consideration to check if they have enough time to get to the port. When the ships get to a port they sell all cargo they can sell, choose a new destination and buy cargo based on the last decision. Before buying they will discard the cargo that would expire before reching the destination.

## Weather
At the beginning of each simulation's day the weather process receives the SIGDAY signal from the master process. It then proceeds to send the SIGSTORM and SIGSWELL signals to random ships and ports respectively. It also implements an itimer in order to be able to send the SIGMAELTROM signal to random ship every SO_MAELTROM simulated hours.

## Semaphore, message, shared_mem
These three modules are utilities that simplify the most common uses of IPCs providing macros and methods to reduce redundancies in the code.

##  Utils and list_cargo
The utils.c module contains utilty methods used by most of the other modules. It also contains the functions used to make operations on the linked list list_cargo, used by ships and ports to represent the stored cargo with the respective expiry dates.